# Руководство по развертыванию

В этом руководстве объясняется, как развернуть Репозиторий на виртуальных машинах под управлением дистрибутивов Linux. Мы рассмотрим различные облачные провайдеры и стратегии развертывания, чтобы помочь вам выбрать наилучший подход для ваших нужд.

## Понимание архитектуры развертывания

Репозиторий использует контейнерную архитектуру с Docker, что делает его легко переносимым между различными средами. Система состоит из нескольких основных сервисов:

- Приложение FastAPI для обработки HTTP-запросов
- Celery workers для обработки фоновых задач
- PostgreSQL для хранения данных и векторного хранилища
- Redis для организации очередей сообщений и кэширования
- Caddy для SSL/TLS терминации и обратного прокси

Эта архитектура обеспечивает масштабируемость и удобство обслуживания, сохраняя при этом простоту развертывания через Docker Compose.

## Требования к виртуальной машине

1. Требования к оборудованию:
    - минимум 4 ГБ оперативной памяти.
2. Требования к программному обеспечению:
    - Docker, docker compose: https://docs.docker.com/engine/install/
    - Git: https://git-scm.com/downloads/linux
    - Любой текстовый редактор (vim, vi, nano и т.д.)
3. SSH-пользователь с root-доступом.
4. SSH-ключ доступа к GitHub
   аккаунту: https://docs.github.com/en/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account
5. Пользовательский домен, указывающий на вашу виртуальную машину.
6. Убедитесь, что стандартные порты для http и https не заблокированы вашим файрволом. Порты 80 и 443 должны быть
   публично доступны. Это обязательно для настройки SSL-сертификата.

## Развертывание

### Обзор

1. SSH-подключение к виртуальной машине.
2. Клонирование репозитория.
3. Настройка .env файлов.
4. Сборка и запуск.
5. Применение миграций базы данных.
6. Проверка.

### Пошаговая инструкция

#### 1. SSH-подключение к виртуальной машине

```bash
ssh username@hostname-or-ip
```

#### 2. Клонирование репозитория

```bash
cd /opt
git clone https://github.com/noteldar/llm-pipeline
```

#### 3. Создание .env файлов

##### Docker

```bash
cd /opt/llm-pipeline/docker
cp .env.example .env
```

Убедитесь, что обновили следующие переменные:

1. DATABASE_PASSWORD (для очевидных причин безопасности)
2. CADDY_DOMAIN: Ваш пользовательский домен здесь

##### Бекенд

```bash
cd /opt/llm-pipeline/app
cp .env.example .env
```

Убедитесь, что обновили пароль базы данных для обеспечения безопасности.

#### 4. Сборка и запуск

Перейдите в директорию docker

```bash
cd /opt/llm-pipeline/docker
```

Убедитесь, что скрипт имеет разрешение на выполнение

```bash
sudo chmod +x start.sh
```

Выполните скрипт

```bash
./start.sh
```

#### 5. Применение миграций базы данных

Перейдите в директорию бекенда

```bash
cd /opt/llm-pipeline/app
```

Убедитесь, что скрипт имеет разрешение на выполнение

```bash
sudo chmod +x migrate.sh
```

Выполните скрипт

```bash
./migrate.sh
```

#### 6. Проверка

Все должно быть запущено и работает. Выполните следующую команду, чтобы проверить, запущены ли все контейнеры Docker:

```bash
docker ps
```

## Варианты облачных провайдеров

Репозиторий можно развернуть на различных облачных провайдерах, каждый из которых предлагает свои преимущества:

### Amazon Web Services (AWS)

- **Рекомендуемая виртуальная машина**: t3.medium или t3.large
- **Преимущества**: 
  - Широкая глобальная инфраструктура
  - Интеграция с AWS сервисами, такими как S3 и RDS
  - Доступ к бесплатному тестовому периоду
- **Начало работы**: Запуск виртуальной машины с Ubuntu Server LTS
### Microsoft Azure

- **Рекомендуемая конфигурация**: B2s или B2ms
- **Ключевые преимущества**:
  - Сильная корпоративная интеграция
  - Комплексные функции безопасности
  - Возможности гибридного облака
- **Начало работы**: Развертывание Linux VM через Azure Portal или CLI

### Google Cloud Platform (GCP)

- **Рекомендуемая конфигурация**: e2-medium или e2-standard-2
- **Ключевые преимущества**:
  - Развитая экосистема AI/ML
  - Глобальная сетевая инфраструктура
  - Щедрый бесплатный уровень
- **Начало работы**: Создание экземпляра Compute Engine с Ubuntu

### Hetzner Cloud

- **Рекомендуемая конфигурация**: CPX31 или CPX41
- **Ключевые преимущества**:
  - Очень выгодные цены
  - Европейские дата-центры
  - Простой процесс развертывания
- **Начало работы**: Создание нового сервера через Hetzner Cloud Console

### DigitalOcean

- **Рекомендуемая конфигурация**: Basic или Regular Droplet (4GB RAM)
- **Ключевые преимущества**:
  - Удобный для разработчиков интерфейс
  - Прозрачное ценообразование
  - Встроенный мониторинг
- **Начало работы**: Создание Droplet с Ubuntu LTS

При выборе облачного провайдера учитывайте следующие факторы:

- Географическое расположение и требования к задержке
- Бюджетные ограничения
- Требования к соответствию и размещению данных
- Существующая инфраструктура и инструменты
- Необходимые возможности масштабирования
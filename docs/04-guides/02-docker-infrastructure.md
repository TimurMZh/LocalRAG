# Docker инфраструктура

Docker инфраструктура Репозитория преобразует сложное многосервисное приложение в легко управляемую среду разработки и развертывания. Это руководство объясняет, как работает наша контейнеризированная архитектура и как максимально эффективно ее использовать.

## Понимание архитектуры

В своей основе Репозиторий работает через четыре основных сервиса, функционирующих в гармонии:

**FastAPI Application** служит входной точкой вашей системы, обрабатывая все входящие HTTP запросы с эффективностью и типобезопасностью, которыми известен FastAPI. За ним **Celery Worker** асинхронно обрабатывает AI задачи, обеспечивая отзывчивость приложения даже во время сложных операций. Эти сервисы поддерживаются **PostgreSQL**, который не только хранит традиционные данные, но и управляет векторными эмбеддингами для AI операций, и **Redis**, который оркеструет коммуникацию между API и воркерами через свои надежные возможности брокера сообщений.

## Процесс разработки

Начать разработку просто. Из корня проекта выполните:

```bash
cd docker
./start.sh
```
Этот скрипт организует тщательно упорядоченный процесс запуска:

1. Сначала он создает изолированные Docker сети для безопасного взаимодействия сервисов
2. Затем инициализирует PostgreSQL и Redis, обеспечивая готовность сервисов данных
3. Наконец, запускает API и worker сервисы с включенной горячей перезагрузкой

### Разработка в реальном времени

Среда разработки создана для оптимального опыта разработчика. Когда вы изменяете код, система автоматически:

- Перезагружает ваш API сервер для немедленного отражения изменений
- Перезапускает workers для применения новых определений задач
- Сохраняет состояние базы данных между перезапусками

Для мониторинга вашего приложения в реальном времени используйте:

```bash
cd docker
./logs.sh
```

Эта команда предоставляет единое представление всех логов контейнеров, с временными метками и цветовой кодировкой для удобной отладки.

## Управление конфигурацией

Конфигурация следует методологии [12-factor app](https://12factor.net/), используя переменные окружения для всех настроек. Начните с создания вашего файла окружения:

```bash
cp docker/.env.example docker/.env
```

Система конфигурации поддерживает несколько окружений через разные файлы .env:
- `.env.development` для локальной разработки
- `.env.staging` для тестовых окружений 
- `.env.production` для продакшн развертывания

## Опции локальной разработки

Инфраструктура поддерживает гибкие подходы к разработке. Вы можете запустить весь стек в контейнерах или комбинировать локальные и контейнеризированные сервисы для более быстрых циклов разработки:

```bash
# Run dependencies in containers
docker-compose up database redis

# Run API locally for faster development
cd app
uvicorn main:app --reload

# Run worker locally for easier debugging
celery -A config.celery_config worker --loglevel=INFO
```
Такой гибридный подход дает вам лучшее из обоих миров:

- Контейнеризированные зависимости для согласованности
- Локальное выполнение сервисов для быстрой обратной связи
- Полные возможности отладки в IDE
- Мгновенная перезагрузка кода

## Развертывание в продакшн

Продакшн окружение строится на основе среды разработки с дополнительными функциями безопасности и надежности:

### Улучшения безопасности
- Сервер [Caddy](https://caddyserver.com/) автоматически обрабатывает SSL/TLS терминацию
- Сервисы запускаются от непривилегированных пользователей
- Изоляция сети между контейнерами
- Безопасное управление учетными данными через переменные окружения

### Функции надежности
- Постоянные тома для сохранности данных
- Лимиты ресурсов контейнеров для предотвращения истощения
- Проверки работоспособности для автоматического восстановления контейнеров
- Структурированное логирование для лучшей наблюдаемости

### Управление ресурсами
- Настраиваемые лимиты CPU и памяти
- Монтирование томов для сохранения данных
- Автоматическое восстановление контейнеров
- Возможности балансировки нагрузки

Продакшн настройка спроектирована как безопасная и поддерживаемая, следуя лучшим практикам Docker и рекомендациям по безопасности. Она обеспечивает надежную основу для запуска ваших AI приложений в любой продакшн среде, от развертывания на одном сервере до сложных облачных инфраструктур.

Docker инфраструктура спроектирована для роста вместе с вашими потребностями, от начальной разработки до продакшн развертывания, сохраняя при этом согласованность и безопасность на протяжении всего жизненного цикла приложения.
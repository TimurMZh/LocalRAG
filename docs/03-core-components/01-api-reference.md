# Документация API слоя

API слой в Репозитории служит основной точкой входа для всех событийно-ориентированных операций. Построенный на FastAPI, этот слой преобразует входящие HTTP запросы в события, которые проходят через событийно-ориентированную архитектуру системы.

## Архитектурный обзор

API слой реализует паттерн "прием-и-делегирование", где запросы быстро валидируются, сохраняются и делегируются фоновым обработчикам. Такой дизайн обеспечивает высокую доступность и отзывчивость, так как API немедленно подтверждает валидные запросы, не дожидаясь полной обработки.

Когда приходит запрос, он проходит через следующие этапы:

1. FastAPI валидирует входящую нагрузку согласно определенным схемам
2. Валидированное событие сохраняется в PostgreSQL
3. Фоновая задача ставится в очередь через Celery
4. API возвращает ответ 202 Accepted с идентификатором задачи

## Основные компоненты

### Зависимости (dependencies.py)

Модуль зависимостей предоставляет основные сервисы для API эндпоинтов через систему внедрения зависимостей FastAPI. Основной зависимостью является менеджер сессий базы данных, который обеспечивает правильную обработку соединений с базой данных:

```python
def db_session() -> Generator:
    session: Session = SessionLocal()
    try:
        yield session
        session.commit()
    except Exception as ex:
        session.rollback()
        raise ex
    finally:
        session.close()
```
Этот паттерн гарантирует правильное управление сессиями базы данных независимо от успеха или неудачи запроса.

### Схема событий (event_schema.py)

Схемы событий определяют контракт между API клиентами и системой. Используя Pydantic модели, мы обеспечиваем строгую валидацию входящих запросов до их поступления в pipeline обработки. Система схем расширяема, позволяя определять пользовательские правила валидации для различных типов событий.

#### Интеграция с Pydantic Model

Pydantic модели служат основой для валидации и сериализации данных. Эти модели обеспечивают:

- Проверку типов и валидацию во время выполнения
- Генерацию JSON схем для OpenAPI документации
- Автоматическую сериализацию/десериализацию сложных типов данных

Пример типичной схемы события:

```python
from pydantic import BaseModel, Field
from typing import Optional, Dict, Any

class EventSchema(BaseModel):
    event_type: str = Field(..., description="Type of event being processed")
    payload: Dict[str, Any] = Field(..., description="Event payload")
    metadata: Optional[Dict[str, Any]] = Field(default={}, description="Optional metadata")
    
    model_config = {
        "json_schema_extra": {
            "examples": [{
                "event_type": "document_processing",
                "payload": {"document_id": "123", "action": "analyze"},
                "metadata": {"priority": "high"}
            }]
        }
    }
```
Для получения дополнительной информации о моделях Pydantic и их возможностях обратитесь к:
- [Документация Pydantic](https://docs.pydantic.dev/)
- [Руководство FastAPI по Pydantic](https://fastapi.tiangolo.com/tutorial/body/#using-pydantic-models)

### Эндпоинты (endpoint.py)

Модуль эндпоинтов реализует базовую логику приема событий. Он следует принципам REST и реализует паттерн "accept-and-delegate":

```python
@router.post("/")
def handle_event(
    data: EventSchema,
    session: Session = Depends(db_session),
) -> Response:
    # Store event
    event = Event(data=data.model_dump(mode="json"))
    repository.create(obj=event)

    # Queue for processing
    task_id = celery_app.send_task(
        "process_incoming_event",
        args=[str(event.id)],
    )

    return Response(
        status_code=HTTPStatus.ACCEPTED
    )
```
### Конфигурация маршрутизатора (router.py)

Модуль маршрутизатора организует эндпоинты в логические группы и применяет общие конфигурации. Такой модульный подход позволяет легко добавлять новые эндпоинты, сохраняя согласованные шаблоны маршрутизации.

## Точки интеграции

API слой интегрируется с несколькими другими компонентами системы:

### Интеграция с базой данных
Через паттерн репозитория, API слой сохраняет события, поддерживая разделение ответственности. Операции с базой данных абстрагированы за интерфейсами репозитория, что делает систему гибкой к изменениям базы данных.

### Интеграция с очередью задач
API слой ставит задачи в очередь для фоновой обработки используя Celery. Эта точка интеграции критически важна для event-driven природы системы, позволяя асинхронно обрабатывать потенциально длительные операции.

### Интеграция валидации
Система валидации FastAPI работает совместно с моделями Pydantic для обеспечения целостности данных до того, как события попадают в pipeline обработки.

## Расширение API

Чтобы добавить новые эндпоинты, следуйте этим шагам:

1. Определите новые схемы в event_schema.py
2. Создайте обработчики эндпоинтов в endpoint.py
3. При необходимости обновите конфигурацию маршрутизатора
4. Реализуйте соответствующие обработчики pipeline

Модульный дизайн делает расширение API простым, сохраняя при этом согласованность и надежность.

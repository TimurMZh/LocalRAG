
---

## Тестирование KazQAD Retrieval с помощью скрипта `test_kazqad_retrieval.py`

### Цель

Скрипт `test_kazqad_retrieval.py` предназначен для автоматической отправки запросов из датасета KazQAD (queries-and-passages) на эндпоинт `/events` с целью тестирования и валидации системы информационного поиска.

---

## Основные возможности

- Загружает датасет KazQAD из Hugging Face
- Формирует структурированные JSON-запросы
- Отправляет их на API эндпоинт
- Логирует успешные и неуспешные ответы
- Выводит итоговую статистику (успешные/неуспешные запросы)
- Может запускаться с аргументами командной строки

---

## Аргументы командной строки

Поддерживаются следующие аргументы:

- `--api-url`: Указывает URL, куда отправлять JSON-запросы. По умолчанию: `http://localhost:8080/events`
- `--limit`: Ограничение количества запросов (например, `--limit 5`)
- `--split`: Какую часть датасета использовать (`train`, `test`, `validation`). По умолчанию: `test`
- `--batch-size`: Через сколько запросов логировать прогресс. По умолчанию: `10`
- `--delay`: Задержка между запросами в секундах. По умолчанию: `0.1`

---

## Как работает

1. **Загрузка датасета**  
   Загружается раздел `test` из KazQAD (или другой, если указан через `--split`). При необходимости ограничивается количеством примеров (`--limit`).

2. **Формирование запроса**  
   Из каждого элемента извлекается:
   - `query`: вопрос
   - `positive_passages`: позитивный текст
   - `negative_passages`: негативный текст

   Всё упаковывается в JSON-объект с дополнительными полями:  
   `ticket_id`, `timestamp`, `from_email`, `to_email`, `subject`, `body`.

3. **Отправка**  
   JSON отправляется POST-запросом на `--api-url`. В зависимости от статуса (200 или 202), результат считается успешным или неудачным.

4. **Отладка**  
   Логгер выводит один пример JSON (ограниченный 500 символами) и отображает прогресс через `tqdm`.

5. **Вывод результатов**  
   Скрипт подсчитывает количество успешных и неуспешных запросов, отображает процент успешности и при необходимости список неудачных примеров.

---

## Где посмотреть результаты

- **Файл логов**: `kazqad_test.log` содержит все логи
- **PostgreSQL база данных**: в таблице `events` (если подключена)
- **В консоли**: выводятся ключевые этапы и статус по каждому элементу
- **В Docker логах**: можно отследить обработку запросов, если запущены воркеры

---

## Подходит для

- Валидации работоспособности endpoint `/events`
- Тестирования интеграции KazQAD + API + База данных
- Отладки JSON-структуры запросов
- Прототипирования и демонстрации пайплайна

---
